# tree-planter

tree-planter is a webhook receiver that is designed to deploy code trees via
either a simple JSON payload or the payload from a GitLab webhook. Cloned
branches can also be deleted via a the GitLab webhook.

Technology-wise, tree-planter is a Ruby application built on [Sinatra][sinatra]. The application is served up by the [Passenger][passenger]
gem. All this has been neatly wrapped up in a Docker container that's based on
the official [ruby:2.4-slim][ruby:2.4-slim] one which, in turn, is based on
the official [debian:jessie][debian:jessie] one.

## Running the container

If you are deploying a git repository somewhere, and you must be if you are
looking to use to use tree-planter, then permissions on the downloaded files
are likely important. For this reason, and a few others, it is suggested that
you run this container as the user on the host system who needs to own the
files. All the example code below assumes you are using [Puppet][puppet]
to manage your servers. If that is not the case you will still need to account
for creating an application user and creating init scripts or systemd unit
files for starting and stopping the container. There are also a couple of
directories that need to be created and have their ownership set to that of the
application user. Now, on with getting your instance of tree-planter up and
running.

First things first, let create the group that lets other users run Docker commands:

```puppet
group { 'docker':
  ensure => 'present',
}
```

Now lets create an application user. Since development of this
project is done inside a VM by way of Vagrant our example user is going to be
named `vagrant`.

```puppet
user { 'vagrant':
  ensure           => 'present',
  gid              => '1000',
  groups           => ['wheel', 'docker'],
  home             => '/home/vagrant',
  password         => '$6$eVECWbuT$6PZ6cqTwG11jrwpgB0g1Q5GyV3Y.UvEiXfT/KR3XP8RfHhHvJsp1.zU1H0ljuhFnw39r.HoSQiXm/RxcqCBQ7/',
  password_max_age => '99999',
  password_min_age => '0',
  shell            => '/bin/bash',
  uid              => '1000',
}
```

A key thing to note in the code above is that the user is in the docker group. This lets them run Docker commands without sudo.

Next, lets make the directories needed for this application.

```puppet
# this is where your git repo(s) will live
file { '/home/vagrant/trees':
  ensure   => 'directory',
  group    => 'vagrant',   # generally the same as your app user
  mode     => '755',       # adjust as needed
  owner    => 'vagrant',   # must be your app user
}

# this is so you can see the logs generated by Sinatra and Passenger
file { '/var/log/tree-planter':
  ensure   => 'directory',
  group    => 'vagrant',
  mode     => '755',
  owner    => 'vagrant',
}
```

Now that our user and directories are in place lets get the container going.

```puppet

```

# Items below here still need updating.

```bash
# This example will need to have names and paths updated to fit your setup.
appuser='vagrant'
mkdir /var/log/tree-planter
chown ${appuser} /var/log/tree-planter
docker run -d \
  -p 80:8080 \
  --name planted_vagrant \
  -v /home/${appuser}/trees:/opt/trees \
  -v /var/log/tree-planter:/var/www/tree-planter/log \
  -e LOCAL_USER_ID=`id -u ${appuser}` \
  genebean/tree-planter

# If you need to pull repositories using an ssh key then do this as part of your
# startup proess:
# Replace /home/vagrant/.ssh/test_id_rsa with the path to your private key
docker cp /home/vagrant/.ssh/test_id_rsa planted_vagrant:/home/user/.ssh/id_rsa
docker exec -it planted_vagrant /bin/sh -c 'chown user.user /home/user/.ssh/id_rsa'
docker exec -it planted_vagrant /bin/sh -c 'chmod 600 /home/user/.ssh/id_rsa'
```


## End Points

tree-planter has the following endpoints:  
* `/` - when the base URL is opened in a browser it show you a list of the
  endpoints.  
* `/deploy` - Deploys the default branch of a repository. It accepts a POST in
  the format of a GitLab webhook or in the custom format shown in the examples
  below.  
* `/gitlab` - Deploys the branch of a repo referenced in the payload of a
  webhook POST from GitLab. Each branch is placed into a folder using the naming
  convention `repository_branch` such as `tree-planter_master`. All /'s are
  replaced with underscores.  
* `/hook-test` - Used for testing and debugging. It displays diagnostic info
  about the payload that was POST'ed.

If using the Vagrant box or running behind Apache on your server these will all
send a fair amount of info to Apache's error log. The error log is used as a
byproduct of how Sinatra / Rack do their logging.


## Examples

### Triggering via cURL:

```bash
# first run
[vagrant@localhost opt]$ curl -H "Content-Type: application/json" -X POST -d \
'{ "tree_name": "tree-planter", "repo_url": "https://github.com/genebean/tree-planter.git" }' \
http://localhost:4567/deploy
tree: tree-planter
repo_url: https://github.com/genebean/tree-planter.git
base: /opt/trees
Running git clone https://github.com/genebean/tree-planter.git tree-planter
Cloning into 'tree-planter'...

# second run
[vagrant@localhost ~]$ curl -H "Content-Type: application/json" -X POST -d \
'{ "tree_name": "tree-planter", "repo_url": "https://github.com/genebean/tree-planter.git" }' \
http://localhost:4567/deploy
tree: tree-planter
repo_url: https://github.com/genebean/tree-planter.git
base: /opt/trees
Running git pull
Already up-to-date.
```

### Example cURL / JSON Syntax

```bash
# Pull master branch with a GitLab-like payload
curl -H "Content-Type: application/json" -X POST -d \
'{"ref":"refs/heads/master", "checkout_sha":"858f1411ecd9d0b7c8f049a98412d1b3dcb68eae", "repository":{"name":"tree-planter", "url":"https://github.com/genebean/tree-planter.git" }}' \
http://localhost/gitlab

# Pull develop branch with a GitLab-like payload
curl -H "Content-Type: application/json" -X POST -d \
'{"ref":"refs/heads/develop", "checkout_sha":"858f1411ecd9d0b7c8f049a98412d1b3dcb68eae", "repository":{"name":"tree-planter", "url":"https://github.com/genebean/tree-planter.git" }}' \
http://localhost/gitlab

# Pull feature/parsable_names branch with a GitLab-like payload
curl -H "Content-Type: application/json" -X POST -d \
'{"ref":"refs/heads/feature/parsable_names", "checkout_sha":"858f1411ecd9d0b7c8f049a98412d1b3dcb68eae", "repository":{"name":"tree-planter", "url":"https://github.com/genebean/tree-planter.git" }}' \
http://localhost/gitlab

# Pull default branch with a GitLab-like payload
curl -H "Content-Type: application/json" -X POST -d \
'{"ref":"refs/heads/master", "checkout_sha":"858f1411ecd9d0b7c8f049a98412d1b3dcb68eae", "repository":{"name":"tree-planter", "url":"https://github.com/genebean/tree-planter.git" }}' \
http://localhost/deploy

# Pull default branch with the tree-planter custom payload
curl -H "Content-Type: application/json" -X POST -d \
'{ "tree_name": "tree-planter", "repo_url": "https://github.com/genebean/tree-planter.git" }' \
http://localhost/deploy

# Delete cloned copy of feature/parsable_names branch with a GitLab-like payload
curl -H "Content-Type: application/json" -X POST -d \
'{"ref":"refs/heads/feature/parsable_names", "checkout_sha":"0000000000000000000000000000000000000000", "repository":{"name":"tree-planter", "url":"https://github.com/genebean/tree-planter.git" }}' \
http://localhost/gitlab
```

[debian:jessie]: https://hub.docker.com/_/debian/
[passenger]: https://www.phusionpassenger.com
[puppet]: https://puppet.com
[ruby:2.4-slim]: https://hub.docker.com/_/ruby/
[sinatra]: http://www.sinatrarb.com
